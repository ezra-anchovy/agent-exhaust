<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agent Exhaust - Mezzanine Gantt View</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: system-ui, -apple-system, sans-serif; 
      background: #0f172a; 
      color: #e2e8f0;
      padding: 20px;
    }
    h1 { margin-bottom: 10px; color: #f97316; }
    .subtitle { color: #94a3b8; margin-bottom: 20px; }
    
    .gantt-container {
      overflow-x: auto;
      background: #1e293b;
      border-radius: 8px;
      padding: 20px;
    }
    
    .gantt {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 1200px;
    }
    
    .gantt-header {
      display: flex;
      border-bottom: 1px solid #334155;
      padding-bottom: 10px;
      margin-bottom: 10px;
    }
    
    .gantt-header-label {
      width: 120px;
      flex-shrink: 0;
      font-weight: 600;
      color: #94a3b8;
    }
    
    .gantt-header-hours {
      display: flex;
      flex: 1;
    }
    
    .gantt-hour-header {
      width: 50px;
      text-align: center;
      font-size: 11px;
      color: #64748b;
    }
    
    .gantt-row {
      display: flex;
      align-items: center;
      height: 36px;
    }
    
    .gantt-row-label {
      width: 120px;
      flex-shrink: 0;
      font-size: 12px;
      color: #94a3b8;
      padding-right: 10px;
    }
    
    .gantt-row-cells {
      display: flex;
      flex: 1;
      gap: 2px;
    }
    
    .gantt-cell {
      width: 48px;
      height: 28px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      cursor: pointer;
      transition: transform 0.1s;
    }
    
    .gantt-cell:hover {
      transform: scale(1.1);
      z-index: 10;
    }
    
    .gantt-cell.empty {
      background: #1e293b;
      border: 1px dashed #334155;
    }
    
    /* Work mode colors */
    .gantt-cell.shipping_sprint { background: #22c55e; color: #000; }
    .gantt-cell.research_dive { background: #3b82f6; color: #fff; }
    .gantt-cell.debugging_session { background: #ef4444; color: #fff; }
    .gantt-cell.maintenance { background: #f59e0b; color: #000; }
    .gantt-cell.planning { background: #8b5cf6; color: #fff; }
    .gantt-cell.mixed { background: #64748b; color: #fff; }
    
    .legend {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
    }
    
    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 3px;
    }
    
    .tooltip {
      position: fixed;
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 6px;
      padding: 12px;
      max-width: 300px;
      z-index: 1000;
      box-shadow: 0 10px 25px rgba(0,0,0,0.5);
      display: none;
    }
    
    .tooltip.visible { display: block; }
    .tooltip h4 { color: #f97316; margin-bottom: 6px; }
    .tooltip p { font-size: 13px; line-height: 1.4; color: #cbd5e1; }
    .tooltip .meta { font-size: 11px; color: #64748b; margin-top: 8px; }
    
    .stats {
      display: flex;
      gap: 30px;
      margin-bottom: 20px;
    }
    
    .stat {
      background: #1e293b;
      padding: 15px 25px;
      border-radius: 8px;
    }
    
    .stat-value { font-size: 28px; font-weight: 700; color: #f97316; }
    .stat-label { font-size: 12px; color: #64748b; }
    
    .loading { text-align: center; padding: 40px; color: #64748b; }
  </style>
</head>
<body>
  <h1>ðŸ¦ž Mezzanine Semantic View</h1>
  <p class="subtitle">Hourly work patterns since Jan 31, 2026</p>
  
  <div class="stats" id="stats">
    <div class="stat">
      <div class="stat-value" id="totalHours">-</div>
      <div class="stat-label">Hours Tracked</div>
    </div>
    <div class="stat">
      <div class="stat-value" id="totalEvents">-</div>
      <div class="stat-label">Total Events</div>
    </div>
    <div class="stat">
      <div class="stat-value" id="dominantMode">-</div>
      <div class="stat-label">Dominant Mode</div>
    </div>
  </div>
  
  <div class="gantt-container">
    <div class="gantt" id="gantt">
      <div class="loading">Loading syntheses...</div>
    </div>
  </div>
  
  <div class="legend">
    <div class="legend-item"><div class="legend-color" style="background:#22c55e"></div> Shipping Sprint</div>
    <div class="legend-item"><div class="legend-color" style="background:#3b82f6"></div> Research Dive</div>
    <div class="legend-item"><div class="legend-color" style="background:#ef4444"></div> Debugging</div>
    <div class="legend-item"><div class="legend-color" style="background:#f59e0b"></div> Maintenance</div>
    <div class="legend-item"><div class="legend-color" style="background:#8b5cf6"></div> Planning</div>
    <div class="legend-item"><div class="legend-color" style="background:#64748b"></div> Mixed</div>
  </div>
  
  <div class="tooltip" id="tooltip">
    <h4 id="tooltip-time"></h4>
    <p id="tooltip-summary"></p>
    <div class="meta" id="tooltip-meta"></div>
  </div>
  
  <script>
    const API_BASE = window.location.origin;
    const tooltip = document.getElementById('tooltip');
    
    async function loadSyntheses() {
      try {
        const res = await fetch(`${API_BASE}/api/syntheses?days=10`);
        const data = await res.json();
        renderGantt(data.syntheses);
      } catch (e) {
        document.getElementById('gantt').innerHTML = `<div class="loading">Error: ${e.message}</div>`;
      }
    }
    
    function renderGantt(syntheses) {
      if (!syntheses.length) {
        document.getElementById('gantt').innerHTML = '<div class="loading">No syntheses yet</div>';
        return;
      }
      
      // Group by date
      const byDate = {};
      let totalEvents = 0;
      const modeCounts = {};
      
      for (const s of syntheses) {
        const date = new Date(s.hour);
        const dateKey = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        const hour = date.getHours();
        
        if (!byDate[dateKey]) byDate[dateKey] = {};
        byDate[dateKey][hour] = s;
        
        totalEvents += s.eventCount || 0;
        modeCounts[s.workMode] = (modeCounts[s.workMode] || 0) + 1;
      }
      
      // Update stats
      document.getElementById('totalHours').textContent = syntheses.length;
      document.getElementById('totalEvents').textContent = totalEvents.toLocaleString();
      const dominant = Object.entries(modeCounts).sort((a,b) => b[1]-a[1])[0];
      document.getElementById('dominantMode').textContent = dominant ? dominant[0].replace('_', ' ') : '-';
      
      // Build HTML
      let html = `
        <div class="gantt-header">
          <div class="gantt-header-label">Date</div>
          <div class="gantt-header-hours">
            ${Array.from({length: 24}, (_, i) => `<div class="gantt-hour-header">${i}:00</div>`).join('')}
          </div>
        </div>
      `;
      
      for (const [dateKey, hours] of Object.entries(byDate).reverse()) {
        html += `
          <div class="gantt-row">
            <div class="gantt-row-label">${dateKey}</div>
            <div class="gantt-row-cells">
              ${Array.from({length: 24}, (_, hour) => {
                const s = hours[hour];
                if (!s) return '<div class="gantt-cell empty"></div>';
                const mode = s.workMode || 'mixed';
                return `<div class="gantt-cell ${mode}" 
                  data-summary="${encodeURIComponent(s.summary || '')}"
                  data-time="${dateKey} ${hour}:00"
                  data-events="${s.eventCount}"
                  data-theme="${s.theme}"
                  data-mode="${mode}"
                >${s.eventCount}</div>`;
              }).join('')}
            </div>
          </div>
        `;
      }
      
      document.getElementById('gantt').innerHTML = html;
      
      // Add tooltip handlers
      document.querySelectorAll('.gantt-cell:not(.empty)').forEach(cell => {
        cell.addEventListener('mouseenter', (e) => {
          const summary = decodeURIComponent(cell.dataset.summary);
          document.getElementById('tooltip-time').textContent = cell.dataset.time;
          document.getElementById('tooltip-summary').textContent = summary;
          document.getElementById('tooltip-meta').textContent = 
            `${cell.dataset.events} events | ${cell.dataset.theme} | ${cell.dataset.mode.replace('_', ' ')}`;
          
          tooltip.style.left = (e.pageX + 10) + 'px';
          tooltip.style.top = (e.pageY + 10) + 'px';
          tooltip.classList.add('visible');
        });
        
        cell.addEventListener('mouseleave', () => {
          tooltip.classList.remove('visible');
        });
      });
    }
    
    loadSyntheses();
    setInterval(loadSyntheses, 60000); // Refresh every minute
  </script>
</body>
</html>
